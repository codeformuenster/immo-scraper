#!/usr/bin/env python
import logging
import os
import sys
from pathlib import Path

import pandas as pd
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail

from immo_scraper.io.paths import AGGREGATED_CSV, ALERTS_IDS

logging.basicConfig(stream=sys.stdout, level=logging.INFO)

# read aggregated data from bucket
df_entries = pd.read_csv(str(AGGREGATED_CSV), dtype={"id": str})

# check for new entries that are relevant to search criteria
df_relevant = (
    df_entries.query("bedroom_number >= 5")
    .query("price <= 400000")
    .query("size >= 100")
    .query("latitude < 52")
)

# read log of historical alerts
alerts_log = []
if ALERTS_IDS.exists():
    with open(str(ALERTS_IDS), "r") as f:
        alerts_log = f.read().splitlines()

# select entries for which alerts are due
df_alert = df_relevant[~df_relevant.id.isin(alerts_log)]

# send alerts
for id in df_alert.id:
    logging.info("Sending out alert...")
    link = df_alert[df_alert.id == id].lister_url.values[0]
    message = Mail(
        from_email=os.environ["FROM_EMAIL"],
        to_emails=os.environ["TO_EMAIL"],
        subject="Immo-scraper: new relevant offer.",
        html_content=f'Found new relevant <a href="{link}">offer</a>.',
    )
    try:
        sg = SendGridAPIClient(os.environ["EMAIL_API_TOKEN"])
        response = sg.send(message)
        print(response.status_code)
        print(response.body)
        print(response.headers)
    except Exception as e:
        print(e.message)

# if alert sent, log this
for id in df_alert.id:
    with open(str(ALERTS_IDS), "a") as f:
        f.write(id + "\n")
